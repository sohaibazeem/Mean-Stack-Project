import{SmartRenderer}from'../../../../fc-core/src/component-interface';import SRSTool from'./srs-tool';import{Separator}from'../../../../fc-core/src/toolbox/tools';import{extend2,TRACKER_FILL}from'../../../../fc-core/src/lib';import{utcMinute,utcHour,utcDay,utcWeek,utcMonth,utcYear,utcSecond,utcQuarter}from'../../../../fc-utils/src/time-intervals/utc';import{timeMinute,timeHour,timeDay,timeWeek,timeMonth,timeYear,timeSecond,timeQuarter}from'../../../../fc-utils/src/time-intervals';import SmartToolbar from'./smart-toolbar';const DURATION_YEAR=31536e6,DURATION_MONTH=26784e5,DURATION_DAY=864e5,DURATION_HOUR=36e5,COLOR_9E9E9E='#9e9e9e',COLOR_DFDFDF='#dfdfdf',DEFAULT_SEPARATOR_HEIGHT=16,standardIntervals=[31536000000,16070400000,8035200000,2678400000,1296000000,604800000,86400000,43200000,21600000,10800000,3600000,1800000],intervalMap={0:{unit:'year',multiplier:1,intervalName:'1Y',tilldateName:'YTD'},1:{unit:'month',multiplier:6,intervalName:'6M'},2:{unit:'month',multiplier:3,intervalName:'3M',tilldateName:'QTD'},3:{unit:'month',multiplier:1,intervalName:'1M',tilldateName:'MTD'},4:{unit:'day',multiplier:15,intervalName:'15D'},5:{unit:'day',multiplier:7,intervalName:'7D',tilldateName:'WTD'},6:{unit:'day',multiplier:1,intervalName:'1D'},7:{unit:'hour',multiplier:12,intervalName:'12H'},8:{unit:'hour',multiplier:6,intervalName:'6H'},9:{unit:'hour',multiplier:3,intervalName:'3H'},10:{unit:'hour',multiplier:1,intervalName:'1H'},11:{unit:'minute',multiplier:30,intervalName:'30m'}},isValidInterVal=function(a,b,c,d=!1,e){let f=this,g=getInterVal(intervalMap[a].unit,f.getFromEnv('isUTC')),h=3*c[2];return!(d?!(e-g.every(intervalMap[a].multiplier).floor(e)>=h):!(standardIntervals[a]>=b[2]&&standardIntervals[a]>=h))},getInterVal=function(a,b){return'year'===a?b?utcYear:timeYear:'quarter'===a?b?utcQuarter:timeQuarter:'month'===a?b?utcMonth:timeMonth:'week'===a?b?utcWeek:timeWeek:'day'===a?b?utcDay:timeDay:'hour'===a?b?utcHour:timeHour:'minute'===a?b?utcMinute:timeMinute:'second'===a?b?utcSecond:timeSecond:void 0},findRelaventFontSize=function(a){let b=a.activated.config.normal['font-size']||0,c=a.activated.config.hover['font-size']||0,d=a.pressed.config.normal['font-size']||0;return Math.max(b,c,d)};class StandardRangeSelector extends SmartRenderer{constructor(){super();let a=this;this._handler=function(){let b,c,d,e=this,f=e.getFromEnv('chart'),g=e.config.multiplier,h=e.getFromEnv('isUTC'),i=e.config.unit,j=e.config.fixedAtEnd,k=e.config.fixedAtStart,l=f.getFocusLimit(),m=f.getContextLimit();a.config.clickedButtonDetails=e.config,e.getFromEnv('animationManager').setAnimationState('selectedRange'),d=j?m[1]:l[1],i&&g?(b=getInterVal(i,h),c=j?b.every(g).floor(d):b.offset(d,-g)):k&&(c=m[0]),a.config.lastSelectedButtonConfig={fixedAtEnd:e.config.fixedAtEnd,fixedAtStart:e.config.fixedAtStart,unit:e.config.unit,multiplier:e.config.multiplier},a.config.updatedThroughButton=!0,f.setFocusLimit([c,d])},this._toolbars={}}__setDefaultConfig(){super.__setDefaultConfig(),this.config.lastSelectedButtonConfig=void 0,this.config.clickedButtonDetails={},this.config.labelFontSize='12px',this.config.stateStyle={activated:{config:{normal:{fill:COLOR_9E9E9E,stroke:'none',"stroke-width":2,cursor:'pointer',"stroke-opacity":1,"fill-opacity":1,opacity:'1',"font-weight":400,"font-size":'12',"text-anchor":'middle'},hover:{fill:'#5648D4',stroke:'none',"stroke-width":2,cursor:'pointer',"stroke-opacity":1,"fill-opacity":1,opacity:'1',"font-weight":400,"font-size":'12',"text-anchor":'middle'},normalBackground:{fill:TRACKER_FILL,stroke:'none',cursor:'pointer'},hoverBackground:{fill:TRACKER_FILL,stroke:'none',cursor:'pointer'}}},pressed:{config:{normal:{fill:'#5648D4',"stroke-width":2,stroke:'none',"symbol-stroke":'#343434',cursor:'pointer',"fill-opacity":1,"stroke-opacity":1,opacity:'1',"font-weight":400,"font-size":'12',"text-anchor":'middle'},hover:{fill:'#5648D4',"stroke-width":2,stroke:'none',"symbol-stroke":'#5648D4',cursor:'pointer',"fill-opacity":1,"stroke-opacity":1,opacity:'1',"font-weight":400,"font-size":'12',"text-anchor":'middle'},normalBackground:{fill:TRACKER_FILL,stroke:'none',cursor:'pointer'},hoverBackground:{fill:TRACKER_FILL,stroke:'none',cursor:'pointer'}}}}}configureAttributes(a){super.configureAttributes(a);let b,c,d,e,f,g,h,i=this.config,j=this.getFromEnv('chart'),k=this.getFromEnv('getStyleDef'),l=this.getFromEnv('baseTextStyle'),m=i.stateStyle;for(let b in i.contextRangeThreshold=j.getFromEnv('contextBins')[0].getRangeThreshold(),i.focusRangeThreshold=j.getFromEnv('focusBins')[0].getRangeThreshold(),i.contextMinBin=j.getFromEnv('contextBins')[0].getBinMin(),i.focusMinBin=j.getFromEnv('focusBins')[0].getBinMin(),a)a.hasOwnProperty(b)&&(i[b]=a[b]);b=Object.assign({},l,k(i.style.button&&i.style.button.text)),c=Object.assign({},l,k(i.style['button:hover']&&i.style['button:hover'].text)),d=Object.assign({},l,k(i.style['button:active']&&i.style['button:active'].text)),e=k(i.style.button&&i.style.button.background),f=k(i.style['button:hover']&&i.style['button:hover'].background),g=k(i.style['button:active']&&i.style['button:active'].background),h=k(i.style.separator&&i.style.separator),m.activated.config.normal=extend2(m.activated.config.normal,b),m.activated.config.hover=extend2(m.activated.config.hover,c),m.pressed.config.normal=extend2(m.pressed.config.normal,d),m.pressed.config.hover=extend2(m.pressed.config.hover,c),m.activated.config.normalBackground=extend2(m.activated.config.normalBackground,e),m.activated.config.hoverBackground=extend2(m.activated.config.hoverBackground,f),m.pressed.config.normalBackground=extend2(m.pressed.config.normalBackground,g),m.pressed.config.hoverBackground=extend2(m.pressed.config.hoverBackground,f),i.stateStyle.separator=h}getTillDateButtons(a,b,c){let d,e,f,g=[],h=this.getFromEnv('chartConfig').contextLimit[1],j=this.getFromEnv('UTC'),k=this.getFromEnv('dateAPI'),l=new Date(h),m=new Date;if(k(l,'FullYear',j)===k(m,'FullYear',j)&&k(l,'Month',j)===k(m,'Month',j)&&k(l,'Date',j)===k(m,'Date',j))for(e=0,f=standardIntervals.length;e<f;e++)a>=standardIntervals[e]&&intervalMap[e].tilldateName&&isValidInterVal.call(this,e,b,c,!0,h)&&(d=extend2({},intervalMap[e]),d.fixedAtEnd=!0,d.fixedAtStart=!1,g.push(d));return g}getSelectionButtonConfig(){let a,b,c,d=this,e=d.config,f=d.getFromEnv('isUTC'),g=e.currentDomain,h={},i=e.totalDomain,j=+g[1]-+g[0];return b=f?utcYear:timeYear,a=f?utcMonth:timeMonth,c=f?utcDay:timeDay,e.lastSelectedButtonConfig?(h={isTillDate:e.lastSelectedButtonConfig.fixedAtEnd&&!e.lastSelectedButtonConfig.fixedAtStart,isAllButton:e.lastSelectedButtonConfig.fixedAtEnd&&e.lastSelectedButtonConfig.fixedAtStart,isIntervalButton:!e.lastSelectedButtonConfig.fixedAtEnd&&!e.lastSelectedButtonConfig.fixedAtStart,multiplier:e.lastSelectedButtonConfig.multiplier,unit:e.lastSelectedButtonConfig.unit},h):j==+i[1]-+i[0]?{isAllButton:!0}:j==+g[1]-+b.floor(g[1])?{isTillDate:!0,multiplier:'1',unit:'year'}:j==+g[1]-+a.floor(g[1])?{isTillDate:!0,multiplier:'1',unit:'month'}:j==+g[1]-+a.every(3).floor(g[1])?{isTillDate:!0,multiplier:'3',unit:'month'}:j==+g[1]-+c.every(7).floor(g[1])?{isTillDate:!0,multiplier:'7',unit:'day'}:d.getHighlightedIntervalButton(j)}getIntervalButtons(a,b,c,d){let e,f=standardIntervals.length,g=[];for(e=f-1;0<e&&!(standardIntervals[e]>=a);e--);return a&&(0>=e?(standardIntervals[0]<=b&&isValidInterVal.call(this,0,c,d)&&g.push(intervalMap[0]),standardIntervals[1]<=b&&isValidInterVal.call(this,1,c,d)&&g.push(intervalMap[1])):e===f-1?(standardIntervals[e-1]<=b&&isValidInterVal.call(this,e-1,c,d)&&g.push(intervalMap[e-1]),standardIntervals[e]<=b&&isValidInterVal.call(this,e,c,d)&&g.push(intervalMap[e])):(standardIntervals[e-1]<=b&&isValidInterVal.call(this,e-1,c,d)&&g.push(intervalMap[e-1]),standardIntervals[e]<=b&&isValidInterVal.call(this,e,c,d)&&g.push(intervalMap[e]),standardIntervals[e+1]<=b&&isValidInterVal.call(this,e+1,c,d)&&g.push(intervalMap[e+1]))),g}getHighlightedIntervalButton(){let a,b,c=this,d=c.config,e=d.intervalButtons,f=d.currentDomain,g=c.getFromEnv('isUTC'),h=e.length,j={};for(a=h-1;0<=a&&(b=getInterVal(e[a].unit,g),+f[0]!=+b.offset(f[1],-e[a].multiplier)&&+f[1]!=+b.offset(f[0],e[a].multiplier));a--);return-1!==a&&(j=extend2({isIntervalButton:!0},intervalMap[a]),j={isIntervalButton:!0,unit:e[a].unit,multiplier:e[a].multiplier},d.lastSelectedButtonConfig=j),j}getToolInfo(){let a,b,c,d,e,f=this,g=f.config,h=f.getFromEnv('chart'),j=f.getFromEnv('selectorToolbar'),k={},l=f.getFromEnv('smartLabel'),m=g.stateStyle,n=findRelaventFontSize(m)||g.labelFontSize,o=m.activated.config.normal['font-family'],p=m.activated.config.normal['font-weight'],q=g.currentDomain,r=h.getContextLimit(),s=g.contextRangeThreshold,t=g.focusRangeThreshold,u=g.contextMinBin,v=g.focusMinBin,w=+q[1]-+q[0],x=+r[1]-+r[0],y=`intervalToolBar-${j.getId()}-${h.getId()}`,z=`businessToolBar-${j.getId()}-${h.getId()}`,A=`allToolBar-${j.getId()}-${h.getId()}`,B=g.intervalButtons=f.getIntervalButtons(w,x,t,v),C=g.tillDateButtons=f.getTillDateButtons(x,s,u);for(l.setStyle({fontSize:n,fontFamily:o,fontWeight:p}),e=f.getSelectionButtonConfig(),k[y]={type:'tool',def:SmartToolbar,configuration:{hAlign:'left',toolbarhdirection:1,child:{}}},(a=0,b=B.length);a<b;a++)c=e.isIntervalButton&&e.unit===B[a].unit&&e.multiplier===B[a].multiplier?'pressed':'activated',d=l.getOriSize(B[a].intervalName,!1),k[y].configuration.child[`intervalButton-${j.getId()}-${h.getId()}-${a}`]={type:'tool',def:SRSTool,configuration:{text:B[a].intervalName,name:'interval',width:d.width,height:d.height,scale:1,marginLeft:a?5:0,marginRight:a===b-1?0:5,hAlign:'left',symbolStrokeWidth:'2',hoveredState:'normal',state:c,multiplier:B[a].multiplier,unit:B[a].unit,strokeWidth:0,listener:{"fc-click":f._handler},css:m}};for(b&&(k[`separator-${j.getId()}-${h.getId()}-0`]={type:'tool',def:Separator,configuration:{marginLeft:0,marginRight:0,scale:1,height:d.height<DEFAULT_SEPARATOR_HEIGHT?DEFAULT_SEPARATOR_HEIGHT:d.height,width:10,hAlign:'left',stroke:m.separator.stroke||COLOR_DFDFDF,css:m.separator}}),k[z]={type:'tool',def:SmartToolbar,configuration:{hAlign:'left',toolbarhdirection:1,child:{}}},(a=0,b=C.length);a<b;a++)c=e.isTillDate&&e.unit===C[a].unit&&e.multiplier===C[a].multiplier&&+q[1]==+r[1]?'pressed':'activated',d=l.getOriSize(C[a].tilldateName,!1),k[z].configuration.child[`tillDateButton-${j.getId()}-${h.getId()}-${a}`]={type:'tool',def:SRSTool,configuration:{text:C[a].tilldateName,name:'interval',scale:1,width:d.width,height:d.height,state:c,multiplier:C[a].multiplier,unit:C[a].unit,symbolStrokeWidth:'2',hoveredState:'normal',fixedAtStart:C[a].fixedAtStart,fixedAtEnd:C[a].fixedAtEnd,marginLeft:a?5:0,marginRight:a===b-1?0:5,hAlign:'left',strokeWidth:0,listener:{"fc-click":f._handler},css:m}};return b&&(k[`separator-${j.getId()}-${h.getId()}-1`]={type:'tool',def:Separator,configuration:{marginLeft:0,marginRight:0,scale:1,height:d.height<DEFAULT_SEPARATOR_HEIGHT?DEFAULT_SEPARATOR_HEIGHT:d.height,classIndex:3,itemIndex:0,width:10,hAlign:'left',stroke:m.separator.stroke||COLOR_DFDFDF,css:m.separator}}),c=e.isAllButton?'pressed':'activated',k[A]={type:'tool',def:SmartToolbar,configuration:{hAlign:'left',toolbarhdirection:1,child:{}}},d=l.getOriSize('All',!1),k[A].configuration.child[`allButton-${j.getId()}-${h.getId()}-0`]={type:'tool',def:SRSTool,configuration:{state:c,width:d.width,height:d.height,scale:1,text:'All',name:'interval',marginLeft:0,marginRight:0,hAlign:'left',hoveredState:'normal',symbolStrokeWidth:'2',strokeWidth:0,fixedAtStart:!0,fixedAtEnd:!0,fill:'#00ff00',labelFill:'#00ff00',symbolFill:'#00ff00',listener:{"fc-click":f._handler},css:m}},k}updateOnLimitChange(){let a,b=this,c=b.getFromEnv('chart');b.config.currentDomain=c.getFocusLimit(),a=b.config.currentDomain[1]-b.config.currentDomain[0],b.config.lastSelectedRange&&b.config.lastSelectedRange!==a&&!b.config.updatedThroughButton&&(b.config.lastSelectedButtonConfig=void 0),b.config.lastSelectedRange=a,b.config.updatedThroughButton=!1,b.setData({},!0)}}export default StandardRangeSelector;