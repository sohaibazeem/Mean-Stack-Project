import{SmartRenderer}from'../../../../fc-core/src/component-interface';import{utcMillisecond,utcSecond,utcMinute,utcHour,utcDay,utcWeek,utcMonth,utcYear}from'../../../../fc-utils/src/time-intervals/utc';import{timeMillisecond,timeSecond,timeMinute,timeHour,timeDay,timeWeek,timeMonth,timeYear}from'../../../../fc-utils/src/time-intervals';import{pluckNumber,pluck,BLANKSTRING,extend2,parseUnsafeString}from'../../../../fc-core/src/lib';import TimeConverter from'../../../../fc-utils/src/time-converter';const GUTTER_2=2,GUTTER_5=5,GUTTER_8=8,GUTTER_14=14;function isValidUnit(a){return!('year'!==a&&'quarter'!==a&&'month'!==a&&'week'!==a&&'day'!==a&&'hour'!==a&&'minute'!==a&&'second'!==a&&'millisecond'!==a)}function getInterVal(a,b){return'year'===a?b?utcYear:timeYear:'quarter'===a?b?utcMonth:timeMonth:'month'===a?b?utcMonth:timeMonth:'week'===a?b?utcWeek:timeWeek:'day'===a?b?utcDay:timeDay:'hour'===a?b?utcHour:timeHour:'minute'===a?b?utcMinute:timeMinute:'second'===a?b?utcSecond:timeSecond:'millisecond'===a?b?utcMillisecond:timeMillisecond:void 0}function isWithinMarker(a,b,c,d){let e,f,g,h,j=!1,k=d.markerDim;for(g=0,h=k.length;g<h;g++)if(b>=k[g].x&&b<=k[g].x+k[g].width&&c>=k[g].y&&c<=k[g].y+k[g].height){j=!0,a.config.previouslyHoveredIndex=d.index,e=k[g];break}return f={pointIndex:d.index,hovered:j,pointObj:{hoveredMarkerDim:e,index:j&&g,type:d.type},previouslyHoveredIndex:a.config.previouslyHoveredIndex,component:a},f}function isValidMarker(a,b,c,d){return!!(a>=c&&a<=d||b<=d&&b>=c||c>=a&&d<=b)}class TimeSpanMinMarker extends SmartRenderer{__setDefaultConfig(){super.__setDefaultConfig(),this.config.defaultStyle={text:{fill:'#808080',opacity:1,"font-size":'10px',"font-weight":'normal',"font-style":'normal',"text-anchor":'middle'},marker:{fill:'#62b58f',opacity:1,"fill-opacity":'1',"stroke-opacity":'1',"border-thickness":0,"border-padding":1,"border-radius":0,"border-dash":'none',"stroke-width":'1'}},this.config.toolTipOpacity=.9,this.config.hoveredIndex=void 0,this.config.previouslyHoveredIndex=void 0,this.config.hoveredOpacity=.5,this.config.valueArr=[],this.config.textArr=[],this.config.styleArr=[],this.config.domainArr=[],this.config.markerDetails=[],this.config.type='minimal'}getHoveredMarker(a,b){let c,d,e=this,f=e.config,g=e.getLinkedParent(),h=g.getTranslation(),j=f.markerDetails;for(a-=h.x,b-=h.y,d=j.length-1;0<=d&&(c=isWithinMarker(e,a,b,j[d]),!c.hovered);d--);return c}setHoverInEffect(a){let b=this,c=b.getFromEnv('chart');b.setData({hoveredIndex:a},!0),c.fireEvent('timeSpanMinMarkerHovered',{senderTimeMarker:b,hoveredIndex:a,hoveredFromOutside:!0})}setHoverOutEffect(){let a=this,b=a.getFromEnv('chart');a.setData({hoveredIndex:void 0},!0),b.fireEvent('timeSpanMinMarkerHovered',{senderTimeMarker:a,hoveredIndex:void 0,hoveredFromOutside:!0})}getToolTextConfiguration(a,b){var c=Math.round;let d,e=this,f=e.config.toolTipOpacity,g=e.getFromEnv('tooltipStyle')||{},h=pluckNumber(g['font-size'],11),i=40,j=26,k=e.getFromEnv('smartLabel');return k.setStyle({"font-size":h+c(.1*h),"font-family":g['font-family'],"font-weight":g['font-weight']}),d=k.getOriSize(a[0]),i+=d.width,j+=d.height,a[1]?(k.setStyle({"font-size":h,"font-family":g['font-family'],"font-weight":g['font-weight']}),d=k.getOriSize(a[1]),j+=d.height,i=Math.max(i,d.width),{toolText:`<div style='opacity:${f}; text-align:center'>
                  <div style='margin: 5px;font-size: ${h+c(.1*h)}px;'>${a[0]}</div>
                  <div style='margin: 5px;'>${a[1]}</div>
                  </div>`,dimensions:{width:i,height:'full'===b?0:j}}):{toolText:`<div style='opacity:${f}; text-align:center; padding: 5px;'>
                <div style= 'font-size: ${h+c(.1*h)}px;'>${a[0]}</div>
                </div>`,dimensions:{width:i,height:'full'===b?0:j}}}getMarkerAndLabelConfiguration(a,b){let c,d,e,f,g,h,i,j,k,l,m=this,n=m.config,o=m.getLinkedParent().config,p=o.padding,q=p.left,r=p.right,s=p.top,t=p.bottom,u=m.config.xScale,v=u.getDomain(),w=n.valueArr[a],x=w.repeat;return c=u.getRangeValue(w.start),l=u.getRangeValue(w.end),f=w.type,e='full'===f?o.canvasTop+GUTTER_2+s:o.canvasTop+o.canvasHeight-GUTTER_2-s+t,g='full'===f?o.canvasTop-o.padding.top:o.canvasTop+o.canvasHeight-(b+4)-s+t,h='full'===f?o.canvasHeight:b+4,n.markerDetails[a].markerDim=[],n.domainArr[a]=[],n.markerDetails[a].index=a,!x&&isValidMarker(+w.start,+w.end,+v[0],+v[1])?(n.domainArr[a].push({start:w.start,end:w.end}),n.markerDetails[a].markerDim.push({x:c-q+r,y:g,width:l-c,height:h}),d=c-q+r,j=w.start,k=w.end):x&&(n.domainArr[a]=i=m.getAllValidDomains(w.start,w.end,w.repeat),i.length&&(d=u.getRangeValue(i[0].start)-q+r,j=i[0].start,k=i[0].end,i.forEach(b=>{c=u.getRangeValue(b.start),l=u.getRangeValue(b.end),n.markerDetails[a].markerDim.push({x:c-q+r,y:g,width:l-c,height:h}),0>x.multiplier&&(d=c-q+r,j=b.start,k=b.end)}))),n.markerDetails[a].type=f,{labelConfiguration:{x:d,y:e,width:l-c-4,startDomain:j,endDomain:k}}}getAllValidDomains(a,b,c){let d=this,e=d.config.xScale,f=e.getDomain(),g=[];if(+a<+f[0]&&0<c.multiplier)for(;!isValidMarker(+a,+b,+f[0],+f[1])&&+a<=+f[1];)a=c.interval.offset(a,c.multiplier),b=c.interval.offset(b,c.multiplier);for(;isValidMarker(+a,+b,+f[0],+f[1]);)g.push({start:a,end:b}),a=c.interval.offset(a,c.multiplier),b=c.interval.offset(b,c.multiplier);return g}configureAttributes(a={}){super.configureAttributes(a);let b,c,d,e,f,g,h,j,k=this,l=k.config,m=[],n=[],o=k.getFromEnv('isUTC'),p=[],q=k.getFromEnv('getStyleDef'),r=a.timeMarker||[];for(r.sort((c,a)=>+new Date(c.start)-+new Date(a.start)),h=0,j=r.length;h<j;h++)r[h].start&&r[h].start!==BLANKSTRING&&(e=pluck(r[h].timeformat,a.defaultFormat),c=o?TimeConverter.utcParser(e):TimeConverter.parser(e),d=c.parse(r[h].start),f=c.parse(r[h].end),d&&f)&&(+d>+f&&([d,f]=[f,d]),b={start:d,end:f,startString:r[h].start,endString:r[h].end,timeFormat:e,type:r[h].type||l.type},r[h].repeat&&r[h].repeat.unit&&0!==Math.floor(+r[h].repeat.multiplier)&&isValidUnit(g=r[h].repeat.unit.toLowerCase())&&(b.repeat={interval:getInterVal(g,o),multiplier:('quarter'===g?3:1)*pluckNumber(r[h].repeat.multiplier,1)}),p.push(b),m.push(q(r[h].style)),n.push(pluck(r[h].label,'')));a.xScale&&(l.xScale=a.xScale),l.hoveredIndex=a.hoveredIndex,a.timeMarker&&(l.valueArr=p,l.styleArr=m,l.textArr=n)}getAllLabelsProps(a,b){let c,d,e,f,g,h,j,k,l,m=this,n=m.config,o=m.getFromEnv('smartLabel'),p=n.valueArr,q=n.domainArr[a],r=n.markerDetails[a],s=m.getFromEnv('isUTC'),t=b.x,u=b.y,v=b.width,w=o._lineHeight,x=[],y=n.textArr[a];for(y&&(f=o.getSmartText(parseUnsafeString(y),v,w),x.push({dim:{x:t+v/2+GUTTER_2,y:u-GUTTER_2},text:parseUnsafeString(f.text)})),d=p[a].timeFormat,(k=0,l=q.length);k<l;k++)j=[],c=q[k],e=r.markerDim[k],h=s?TimeConverter.utcFormatter(d):TimeConverter.formatter(d),g=h.format(c.start)+' - '+h.format(c.end),j.push(g),y&&j.push(f.oriText),e.toolTextArr=j;return x}createGroup(){let a=this,b=a.getLinkedParent().config,c=b.padding,d=b.canvasBGLeft-c.left,e=b.canvasBGTop-c.top,f=b.canvasBGWidth,g=b.canvasBGHeight,h=[`M${d},${e}`,`L${d+f},${e}`,`L${d+f},${e+g}`,`L${d},${e+g}Z`];a.addGraphicalElement({el:'group',container:{id:'thermo',label:'group',isParent:!0},component:a,label:'timeMarker',attr:{name:'time-marker-min-group',"clip-path":h},id:'timeMarker'})}drawAllLabels(a,b){let c=this;a.forEach((a,d)=>{c.addGraphicalElement({el:'text',attr:{text:a.text,x:a.dim.x,y:a.dim.y,opacity:b.text.opacity},css:b.text,container:{label:'timeMarker'},id:'time-marker-label-'+d,component:c,label:'label'})})}draw(){let a,b,c,d,e,f,g,h,k=this,l=k.config,m=k.getFromEnv('smartLabel'),n=l.valueArr,o=k.getFromEnv('textStyle'),p=k.getFromEnv('baseTextStyle'),q=l.defaultStyle,r=l.styleArr;for(k.createGroup(),l.markerDetails=[],(f=0,h=n.length);f<h;f++)if(l.markerDetails[f]={},Object.assign(q.text,p),q.text['vertical-align']='full'===n[f].type?'top':'bottom',a=extend2(extend2(extend2({},{text:o}),q),r[f]),m.setStyle({"font-size":a.text['font-size'],"font-family":a.text['font-family'],"font-weight":a.text['font-weight']}),m.getOriSize(l.textArr[f]),c=k.getMarkerAndLabelConfiguration(f,m._lineHeight),d=l.markerDetails[f].markerDim,e=c.labelConfiguration,d.length){for(b=k.getAllLabelsProps(f,e,a),g=0;g<d.length;g++)k.addGraphicalElement({el:'rect',attr:{x:d[g].x,y:d[g].y,width:d[g].width,height:d[g].height,stroke:a.marker.stroke,"stroke-width":a.marker['stroke-width'],fill:a.marker.fill,opacity:l.markerDetails[f].index===l.hoveredIndex?.5*a.marker.opacity:.2*a.marker.opacity,"fill-opacity":l.markerDetails[f].index===l.hoveredIndex?a.marker['fill-opacity']:a.marker['fill-opacity'],"stroke-opacity":l.markerDetails[f].index===l.hoveredIndex?a.marker['stroke-opacity']:a.marker['stroke-opacity'],"stroke-dasharray":a.marker['stroke-dasharray']},container:{label:'timeMarker'},id:'time-span-marker-'+f+g,component:k,label:'line'});k.drawAllLabels(b,a)}}getType(){return'timeMarker'}getName(){return'timeSpanMinMarker'}}export default TimeSpanMinMarker;