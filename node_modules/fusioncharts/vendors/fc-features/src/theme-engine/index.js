import{ComponentInterface}from'../../../fc-core/src/component-interface';import{getDepsByType}from'../../../fc-core/src/dependency-manager';import{raiseWarning}from'../../../fc-core/src/event-api';let UNDEF,themer,BLANK='',OBJECTSTRING='object',arrayToStr='[object Array]',objectToStr='[object Object]',isImportantRegEx=/\s+!important$/,importantStrRegEx=/\\!important$/,getValueFromObjProperty=function(a,b){var c,d;for(d in b=(b+'').toLowerCase(),a)if(a.hasOwnProperty(d)&&b===(d+'').toLowerCase()){c=a[d];break}return c},hasFunc=function(a){var b,c;for(b=0,c=a.length;b<c;b++)if('function'==typeof a[b])return!0;return!1},getArrayFromObj=function(a){var b,c=[];for(b in a)c[b]=a[b];return c},trimString=function(a){a=a.replace(/^\s\s*/,'');for(var b=/\s/,c=a.length;b.test(a.charAt(c-=1)););return a.slice(0,c+1)},getRegisteredThemes=a=>{let b,c={};for(var d in a)a.hasOwnProperty(d)&&(b=a[d],c[b.name]=b);return c},checkCyclicRef=function(a,b){for(var c=b.length,d=-1;c--;)if(a===b[c])return d=c,d;return d},merge=function(a,b,c,d,e){var f,g,h,i,j;if(e?(d.push(a),e.push(b)):(d=[a],e=[b]),b instanceof Array)for(f=0;f<b.length;f+=1){try{g=a[f],h=b[f]}catch(a){continue}typeof h==OBJECTSTRING?((null===g||typeof g!=OBJECTSTRING)&&(g=a[f]=h instanceof Array?[]:{}),j=checkCyclicRef(h,e),-1===j?merge(g,h,c,d,e):g=a[f]=d[j]):!(c&&h===UNDEF)&&(a[f]=h)}else for(f in b){try{g=a[f],h=b[f]}catch(a){continue}null!==h&&typeof h==OBJECTSTRING?(i=Object.prototype.toString.call(h),i===objectToStr?((null===g||typeof g!=OBJECTSTRING)&&(g=a[f]={}),j=checkCyclicRef(h,e),-1===j?'data'===f&&h._dataStore?a[f]=h:merge(g,h,c,d,e):g=a[f]=d[j]):i===arrayToStr?((null===g||!(g instanceof Array))&&(g=a[f]=[]),j=checkCyclicRef(h,e),-1===j?merge(g,h,c,d,e):g=a[f]=d[j]):a[f]=h):a[f]=h}return a},extend2=function(a,b,c){return typeof a!=OBJECTSTRING&&typeof b!=OBJECTSTRING?null:typeof b!=OBJECTSTRING||null===b?a:(typeof a!=OBJECTSTRING&&(a=b instanceof Array?[]:{}),merge(a,b,c),a)},checkImportance=function(a){var b={important:!1,str:BLANK};return a?(a=a.toString(),isImportantRegEx.test(a)?(a=a.replace(isImportantRegEx,BLANK),b.important=!0):(a=a.replace(importantStrRegEx,'!imporant'),b.important=!1),b.str=a,b):b},mergeThemeWithData=function(a,b){var c,d,e,f=b.getAll();for(c in f)d=f[c].toString(),e=checkImportance(d),e.important?a[c.toLowerCase()]=e.str:a[c.toLowerCase()]===UNDEF&&(a[c.toLowerCase()]='object'==typeof f[c]?f[c]:e.str)},recursiveApply=function(a,b){var c,d,e,f,g,h,k,l,m,n=b.type,o=0,p=0;for(c in a)if(d=a[c],l='timeseries'===n&&b.themeComponents[c]&&hasFunc(b.themeComponents[c]),d instanceof Array&&!l)for(h=d.length,g=0;g<h;g+=1)f=d[g],'object'==typeof f&&('category'===c?'true'===f.vline?(e=b.component('vline',o,f),e&&(mergeThemeWithData(f,e),o+=1)):(e=b.component('category',p,f,h),e&&(mergeThemeWithData(f,e),p+=1)):(e=b.component(c,g,f,h),e&&(mergeThemeWithData(f,e),recursiveApply(f,e))));else if('object'==typeof d)if(!l)e=b.component(c,null,d),e&&(mergeThemeWithData(d,e),recursiveApply(d,e));else if(e=b.component(c,null,d),m=e.getAll(),a[c]=m,/^\d+$/.test(Object.keys(m).join('')))for(m=getArrayFromObj(m),a[c]=m,k=0;k<a[c].length;k++)recursiveApply(a[c][k],e);else recursiveApply(d,e)};class ThemeManager extends ComponentInterface{configure(){this.config.themeStore||(this.config.themeStore={})}add(a){for(var b,c=this,d=0,e=a.length;d<e;d+=1)b=a[d].name,b&&(c.config.themeStore[b]=a[d])}themify(a,b,c,d,e){var f,g,h=this,j=b.jsVars,k=a.split(','),l=[],m=k.length;if(h.config.themeStore=getRegisteredThemes(getDepsByType('theme')),m){for(g=0;g<m;g+=1)f=h.config.themeStore[trimString(k[g])],f&&l.push(ThemeManager.evaluateThemeJSON(f.theme,b,c,e));l.length?(j.themeObject=new ThemeInstance(l,b,!1,d,c),ThemeManager.applyTheme(b)):raiseWarning(b,'14051100501','run','api.themes~themify()','The theme "'+a+'" requested has not been registered.')}}static evaluateThemeJSON(a,b,c,d){var e,f,g={},h=b.jsVars,i=function(a){var b,c;for(b in a)c=a[b],g[b]=c instanceof Array?extend2(g[b]||[],c):'object'==typeof c?extend2(g[b]||{},c):c};return c=c||b.chartType(),h.themeObject&&a!==h.themeObject&&(h.themeObject.dispose(),delete h.themeObject),i(getValueFromObjProperty(a,'base')),d&&(e=getValueFromObjProperty(a,d)),e&&i(e),c&&(f=getValueFromObjProperty(a,c)),f&&i(f),g}static applyTheme(a){var b=a.jsVars.themeObject,c=b.getThemedJSONData().data;c&&recursiveApply(c,b)}}class ThemeInstance extends ComponentInterface{constructor(a,b,c,d,e){super();var f,g=0;for(this.themeArray=a,this.themeComponents={},this.base={},this.type=e,this.chartInstance=b,this.isChildInstance=!!c,this.themedData=c?null:d,this.length=a.length,f=a.length;g<f;g+=1)this.parse(a[g])}pushTheme(a,b=!1){a&&(this.themeArray.push(a),this.parse(a,b),this.length+=1)}parse(a,b){var c,d,e,f,g,h=this,i=h.themeComponents,j=h.chartInstance,k=h.base,l=h.type,m=h.isChildInstance;for(d in g=a,g)'string'==typeof g[d]||'number'==typeof g[d]?k[d]?(e=checkImportance(g[d]),f=checkImportance(k[d]),(e.important||!f.important)&&(k[d]=g[d])):k[d]=g[d]:'timeseries'===l&&m?g[d]instanceof Array&&'palettecolors'!==d&&!b?(!i[d]&&(i[d]=[]),i[d].push(extend2([],g[d]))):('object'==typeof g[d]||b)&&(k[d]=g[d]):(i[d]||(i[d]=[]),c=i[d],g[d]instanceof Array?c.push(extend2([],g[d])):'object'==typeof g[d]?c.push(new ThemeInstance([g[d]],j,!0,{},h.type)):'function'==typeof g[d]&&c.push(g[d]))}merge(a){var b,c,d,e=this,f=e.base,g=a.base,h=e.themeComponents,i=a.themeComponents;for(d in g)b=checkImportance(f[d]),c=checkImportance(g[d]),(!b.important||c.important)&&(f[d]=g[d]);for(d in i)h[d]=h[d]?h[d].concat(i[d]):[].concat(i[d]);e.length+=a.length}get(a){return this.base[a]}getAll(){return extend2({},this.base)}component(a,b,c,d){var e,f,g,h,j,k,l=this,m=l.themeComponents,n=l.chartInstance,o=l.type,p=new ThemeInstance([],n,!0,{},l.type);if(j=m[a],!j)return null;for(f=0,g=j.length;f<g;f+=1)k=j[f],'function'==typeof k?'timeseries'===o?p.pushTheme(k.call(n,c),!0):(b=b||0,p.pushTheme(k.call(n,b,c,d))):k instanceof Array?(b=b||0,h=k.length,b%=h,e=k[b],e instanceof ThemeInstance?p.merge(e):'function'==typeof e?p.pushTheme(e.call(n,b,c,d)):p.pushTheme(e)):k instanceof ThemeInstance?p.merge(k):p.pushTheme(k);return p}getThemedJSONData(){return{data:this.themedData}}dispose(){var a,b,c=this,d=c.themeComponents;for(a in d)if(b=d[a].length,b){for(;b--;)d[a][b].dispose&&d[a][b].dispose();delete d[a]}c.themeComponents=null,c.chartInstance=null,c.base=null,c.themeArray=null,c.isChildInstance=null,c.dataWithoutTheme=null}}themer=new ThemeManager,themer.configure();function FCPlugger(a){var b=function(b){var c,d,e,f=b.sender,g=f.getFromEnv('chartInstance'),h=getRegisteredThemes(getDepsByType('theme')),j=f.getFromEnv('dataSource'),k=a.options.defaultTheme,l=j&&(j.chart&&j.chart.theme||j.map&&j.map.theme),m=(k||l)&&`${k||''},${l||''}`,n=m&&m.split(','),o=n&&n.length,p=!1;for(d=0;d<o;d++)e=trimString(n[d]),h&&''!==e&&h.hasOwnProperty(e)&&(p=!0);p?(j=extend2({},f.getFromEnv('dataSource')),c=g.chartType(),j.map&&(j.chart=j.map,delete j.map),themer.themify(m,g,c,j,'geo'===g.apiInstance.defaultSeriesType&&'geo'),f.addToEnv('dataSource',j)):g.jsVars&&g.jsVars.themeObject&&(g.jsVars&&g.jsVars.themeObject.dispose(),g.jsVars&&delete g.jsVars.themeObject)};a.addEventListener('internal.dataSanitized',b)}export default{extension:FCPlugger,name:'ThemeEngine',type:'extension',requiresFusionCharts:!0};